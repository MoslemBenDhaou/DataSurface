name: Publish NuGet

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 1.2.3). Leave empty to use tag version."
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build-pack-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # helpful for SourceLink/versioning

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Determine version
        id: ver
        shell: bash
        run: |
          # If workflow_dispatch input provided, use it; else if tag push, use tag without leading 'v'
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            REF="${GITHUB_REF_NAME}"
            VERSION="${REF#v}"
          fi

          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+([-.].+)?$ ]]; then
            echo "Invalid VERSION: $VERSION"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Restore
        run: dotnet restore

      - name: Build (Release)
        run: dotnet build -c Release --no-restore

      - name: Pack solution (Release)
        run: dotnet pack -c Release --no-build -o ./artifacts /p:Version=${{ steps.ver.outputs.version }}

      - name: List packages (debug)
        shell: bash
        run: |
          ls -la ./artifacts || true
          echo "NUPKG:"
          ls -la ./artifacts/*.nupkg 2>/dev/null || true
          echo "SNUPKG:"
          ls -la ./artifacts/*.snupkg 2>/dev/null || true

      - name: Push packages to NuGet.org
        run: dotnet nuget push "./artifacts/*.nupkg" \
              --api-key "${{ secrets.NUGET_API_KEY }}" \
              --source "https://api.nuget.org/v3/index.json" \
              --skip-duplicate

      - name: Push symbols to NuGet.org (if any)
        shell: bash
        run: |
          shopt -s nullglob
          files=(./artifacts/*.snupkg)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No .snupkg found, skipping symbols push."
            exit 0
          fi

          dotnet nuget push "./artifacts/*.snupkg" \
            --api-key "${{ secrets.NUGET_API_KEY }}" \
            --source "https://api.nuget.org/v3/index.json" \
            --skip-duplicate
